# 1 背景

目前的安装包在打包过程以及交付流程上存在一些问题，比如：

- 安装包太大（一般都会超过1GB），而且每个安装包都需要上传bos，不仅上传效率不高，而且耗费bos资源；

- 版本管理比较困难，虽然可以将不同版本上传到bos，但是很难追溯不同版本的差异；而且交付给用户的包，各自用了模块的那些版本，在安装包中没记录；

# 2 整体设计思路

- 分离经常变更的部分与不常变更的部分：将经常变更的部分统一用git管理，不常变更的部分仍然上传到bos；
- 减少安装包的大小，大文件延迟下载：安装包尽量不包含大文件，但是包含大文件的引用文件，这些引用文件描述了如何获取大文件，包括协议、地址等，可以帮助下载大文件；

# 3 文件分离

就目前的经验来看，安装包中的文件大体分为以下两类：

- A类文件：安装脚本本身的代码、模块的配置文件等，特点是：体积小，常变更；
- B类文件：镜像、软件的离线安装包、模型数据等，特点是： 体积大，少变更；

现考虑针对两类文件，采用不同的方式进行管理：

- A类文件采用git进行管理，组装安装包时直接从git拉取，将git版本写入安装包中；

- B类文件依旧托管在bos上，组装安装包时，并不进行真实文件的下载，只是写入一个引用（ref）文件，该文件标识了该从何处获取目标文件（比如存储bos有效性为1天的链接），以及目标文件的校验和；

一个ref文件大体格式如下：

```
{
	"name": "openresty.tgz",
	"protocol": "bos",
	"protocol-content": {
			"fileKey": "openresty-1.0.tgz"
	},
	"md5sum": "7e9f3f91c48189728666509167375b65"
}
```

# 4 延迟下载

如上所述，交付用户的安装包，实际上包含了A类文件与B类文件的引用，需要再执行download.sh/download.bat根据引用文件完成对B类文件的下载。此处“延迟”的意思也就是将下载的动作转移到用户拿到安装包之后，而不是我们组装安装包的时候。

download.sh/download.bat目前至少需要支持以下几个功能：

- 解析refs文件并下载：需要能够解析生成的refs文件，并将文件下载到正确的相对路径；
- 文件完整性校验：下载完成后根据引用文件中的校验和进行校验。下载前如果文件已存在，会计算校验和进行比对，如果校验和正确，则不会再下载该文件；
- 断点续传：文件一般较大，如果用户下载过程中网络出现问题，再次执行download脚本时，可以从上次未完成的地方继续下载；